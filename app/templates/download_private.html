{% extends "base.html" %}

{% block title %}Download Private File - File Storage{% endblock %}

{% block content %}
<div class="card" style="text-align: center;">
    <h2>Download Private File</h2>
    <div id="download-content">
        <div class="loading">
            <p>Preparing download...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Require authentication for private downloads
    if (!requireAuth()) {
        // requireAuth will redirect if not authenticated
    }
    
    async function initializeDownload() {
        const pathParts = window.location.pathname.split('/');
        const fileName = decodeURIComponent(pathParts[pathParts.length - 1]);
        
        const contentDiv = document.getElementById('download-content');
        
        try {
            // Check if file exists and get info
            const response = await apiCall(`/api/download/private/${encodeURIComponent(fileName)}`, {
                method: 'HEAD'
            });
            
            if (response.ok) {
                const fileSize = response.headers.get('Content-Length');
                const contentType = response.headers.get('Content-Type');
                
                contentDiv.innerHTML = `
                    <div class="file-info" style="margin-bottom: 2rem;">
                        <div class="file-name" style="font-size: 1.25rem; font-weight: 500; margin-bottom: 0.5rem;">${escapeHtml(fileName)}</div>
                        ${fileSize ? `<div class="file-size">Size: ${formatFileSize(parseInt(fileSize))}</div>` : ''}
                        ${contentType ? `<div class="file-type">Type: ${contentType}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; align-items: stretch;">
                        <button class="btn" onclick="downloadFile('${escapeHtml(fileName)}')">
                            Download File
                        </button>
                        <button class="btn btn-secondary" onclick="copyDownloadLink()">Copy Link</button>
                        <a href="/files" class="btn btn-secondary" style="text-decoration: none; color: white; display: inline-block; box-sizing: border-box;">Back to Files</a>
                    </div>
                `;
            } else if (response.status === 404) {
                contentDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>File not found</strong><br>
                        The file "${escapeHtml(fileName)}" does not exist or you don't have permission to access it.
                    </div>
                    <a href="/files" class="btn" style="text-decoration: none; color: white;">Back to Files</a>
                `;
            } else {
                throw new Error('Failed to access file');
            }
        } catch (error) {
            contentDiv.innerHTML = `
                <div class="alert alert-error">
                    <strong>Error accessing file</strong><br>
                    Please check your connection and try again.
                </div>
                <a href="/files" class="btn" style="text-decoration: none; color: white;">Back to Files</a>
            `;
        }
    }
    
    async function downloadFile(fileName) {
        try {
            const response = await apiCall(`/api/download/private/${encodeURIComponent(fileName)}`);
            
            if (response.ok) {
                // Create blob and download
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
            } else {
                showAlert('Download failed. Please try again.');
            }
        } catch (error) {
            showAlert('Download failed. Please check your connection and try again.');
        }
    }
    
    function copyDownloadLink() {
        const pathParts = window.location.pathname.split('/');
        const fileName = decodeURIComponent(pathParts[pathParts.length - 1]);
        const downloadUrl = `${window.location.origin}/download/private/${encodeURIComponent(fileName)}`;
        copyToClipboard(downloadUrl);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize download when page loads
    document.addEventListener('DOMContentLoaded', initializeDownload);
</script>
{% endblock %}